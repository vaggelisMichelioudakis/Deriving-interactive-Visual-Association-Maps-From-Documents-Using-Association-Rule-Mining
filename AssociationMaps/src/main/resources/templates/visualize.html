<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Taxonomy Explorer</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        /* CSS Variables for easy themeing */
        :root {
            --bg-color: #f4f7f6;
            --sidebar-bg: #ffffff;
            --main-bg: #ffffff;
            --network-bg: #f9f9f9;
            --text-color: #333333;
            --text-light: #666666;
            --border-color: #e0e0e0;
            --primary-color: #3498db;
            --primary-hover: #2980b9;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --shadow-heavy: rgba(0, 0, 0, 0.1);
            --header-height: 60px;
        }

        /* Dark Mode */
        body.dark-mode {
            --bg-color: #171a22;
            --sidebar-bg: #20272e;
            --main-bg: #171e25;
            --network-bg: #3b4f63;
            --text-color: #ecf0f1;
            --text-light: #bdc3c7;
            --border-color: #4a657f;
            --primary-color: #19252c;
            --primary-hover: #4ea8e1;
        }

        /* Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            width: 100%;
            height: var(--header-height);
            background-color: var(--sidebar-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px var(--shadow-color);
            z-index: 100;
        }

        header h1 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-left: 10px;
        }

        #sidebar-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.8rem;
            color: var(--text-light);
            padding: 5px;
        }
        #sidebar-toggle:hover {
            color: var(--primary-color);
        }

        /* Main App Container */
        .app-container {
            display: flex;
            height: calc(100vh - var(--header-height));
            width: 100%;
        }

        /* Sidebar */
        #sidebar {
            width: 320px;
            height: 100%;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            box-shadow: 2px 0 5px var(--shadow-color);
            padding: 20px;
            overflow-y: auto;
            transition: width 0.3s ease, padding 0.3s ease;
            z-index: 50;
        }

        .app-container.sidebar-collapsed #sidebar {
            width: 0;
            padding: 20px 0;
            overflow: hidden;
        }

        #sidebar h3 {
            font-size: 1.1rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        #sidebar h3:first-child {
            margin-top: 0;
        }

        #sidebar .control-group {
            margin-bottom: 15px;
        }

        #sidebar label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-light);
        }

        #sidebar input[type="text"],
        #sidebar input[type="number"],
        #sidebar select {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: border-color 0.2s;
        }

        #sidebar input:focus, #sidebar select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        #sidebar button {
            width: 100%;
            padding: 10px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button#enter {
            background-color: var(--primary-color);
            color: white;
            margin-top: 10px;
        }
        button#enter:hover {
            background-color: var(--primary-hover);
        }

        button.secondary-btn {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            margin-top: 10px;
        }
        button.secondary-btn:hover {
            background-color: var(--border-color);
        }

        /* Folder path input group */
        .path-group {
            display: flex;
        }
        .path-group input[type="text"] {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
        }
        .path-group button {
            width: auto;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            white-space: nowrap;
        }

        /* View Controls (Slider/Checkbox) */
        .view-control {
            margin-bottom: 15px;
            padding: 10px;
            background-color: var(--bg-color);
            border-radius: 5px;
        }
        .view-control label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            color: var(--text-color);
        }
        #slider-container {
            padding: 0;
        }
        #slider-container label {
            flex-direction: column;
            align-items: flex-start;
        }
        input[type="range"] {
            width: 100%;
            margin-top: 8px;
        }
        #checkbox-container {
            padding: 0;
        }

        /* Dark Mode Toggle */
        .dark-mode-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--bg-color);
            border-radius: 5px;
            margin-top: 20px;
        }
        .dark-mode-toggle label {
            margin-bottom: 0;
            font-weight: 500;
            color: var(--text-color);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input { display: none; }
        .slider-round {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .slider-round:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider-round {
            background-color: var(--primary-color);
        }
        input:checked + .slider-round:before {
            transform: translateX(22px);
        }

        /* Main Content Area */
        #main-content {
            flex-grow: 1;
            height: 100%;
            position: relative;
        }

        #empty-space {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--main-bg);
            position: relative;
        }

        #network-container {
            width: 100%;
            height: 100%;
            background-color: var(--network-bg);
            position: absolute;
            top: 0;
            left: 0;
        }

        #drop_zone {
            border: 3px dashed var(--border-color);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background-color: var(--sidebar-bg);
            color: var(--text-light);
            width: 400px;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: border-color 0.3s, background-color 0.3s;
        }
        #drop_zone p {
            font-size: 0.9rem;
            line-height: 1.6;
        }
        #drop_zone:hover {
            border-color: var(--primary-color);
            background-color: var(--bg-color);
        }

        /* Loading Container */
        #loading-container {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent overlay */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        /* New spinner animation */
        .spinner {
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        #loading-container p {
            font-size: 1.1rem;
            font-weight: 600;
            color: #ffffff;
            margin-top: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Info Panel */
        #info-panel {
            display: none;
            position: absolute;
            background-color: var(--sidebar-bg);
            border: 1px solid var(--border-color);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 4px 12px var(--shadow-heavy);
            font-family: Arial, sans-serif;
            font-size: 14px;
            color: var(--text-color);
            max-width: 300px;
        }
        #info-panel p {
            margin: 0;
            line-height: 1.5;
        }
        #info-panel strong {
            color: var(--primary-color);
        }

        /* Hidden file input */
        #folderInput {
            display:none
        }

        /* Responsive */
        @media (max-width: 768px) {
            header {
                height: 50px;
            }
            header h1 {
                font-size: 1.2rem;
            }
            .app-container {
                flex-direction: column;
                height: calc(100vh - 50px);
            }
            #sidebar {
                width: 100%;
                height: 40%; /* Make sidebar a portion of the height */
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                box-shadow: 0 2px 5px var(--shadow-color);
            }
            .app-container.sidebar-collapsed #sidebar {
                height: 0;
                width: 100%;
                padding: 0 20px;
            }
            #main-content {
                height: 60%; /* Main content takes remaining height */
            }
            #sidebar-toggle {
                display: none; /* Hide toggle on mobile, layout is different */
            }
        }

    </style>
</head>
<body>

<header>
    <button id="sidebar-toggle" title="Toggle Sidebar">â˜°</button>
    <h1>Word Taxonomy Explorer</h1>
</header>

<div class="app-container">

    <aside id="sidebar">

        <h3>Parameters</h3>

        <div class="control-group">
            <label for="path">Folder path:</label>
            <div class="path-group">
                <input type="text" id="path" placeholder="Local Folder Path">
                <button onclick="folderSelector()" class="secondary-btn">Select</button>
            </div>
        </div>

        <input type="file" id="folderInput" webkitdirectory directory multiple>

        <div class="control-group">
            <label for="text_mining">Text Mining Granularity:</label>
            <select id="text_mining">
                <option value="">Select Standard</option>
                <option value="DOCUMENT">Option 1 - DOCUMENT</option>
                <option value="PARAGRAPH">Option 2 - PARAGRAPH</option>
                <option value="SENTENCE">Option 3 - SENTENCE</option>
                <option value="CHUNK">Option 4 - CHUNK</option>
            </select>
        </div>

        <div class="control-group">
            <label for="chunkThr">Chunk Threshold:</label>
            <input type="number" id="chunkThr" placeholder="Enter Threshold (if CHUNK)">
        </div>

        <div class="control-group">
            <label for="support">Support:</label>
            <input type="text" id="support" placeholder="Enter Support (e.g., 0.1)">
        </div>

        <div class="control-group">
            <label for="confidence">Confidence:</label>
            <input type="text" id="confidence" placeholder="Enter Confidence (e.g., 0.5)">
        </div>

        <div class="control-group">
            <label for="phrase_length">Phrase Length:</label>
            <input type="text" id="phrase_length" placeholder="Enter Phrase Length (e.g., 3)">
        </div>

        <div class="control-group">
            <label for="topk">Top-K Rules (by PageRank):</label>
            <input type="number" id="topk" placeholder="e.g., 50">
        </div>

        <button id="enter">Submit</button>

        <h3>View Options</h3>

        <div id="slider-container" class="view-control">
            <label for="slider">Node Font Size:
                <input type="range" id="slider" min="10" max="50" value="14">
            </label>
        </div>

        <div id="checkbox-container" class="view-control">
            <label for="hide-edges-checkbox">Hide Edges
                <input id="hide-edges-checkbox" type="checkbox">
            </label>
        </div>

        <div class="dark-mode-toggle">
            <label for="dark-mode-toggle">Dark Mode</label>
            <label class="switch">
                <input type="checkbox" id="dark-mode-toggle">
                <span class="slider-round"></span>
            </label>
        </div>

    </aside>

    <main id="main-content">
        <div id="empty-space">
            <div id="network-container">
                <div id="drop_zone">
                    <p>USE A FOLDER PATH THAT CONTAINS TXT FILES. <br>
                        SUPPORT > 0. <br>
                        0 < CONFIDENCE < 1. <br>
                        SET PHRASE LENGTH TO AN INTEGER > 0. <br>
                    </p>
                </div>
            </div>

            <div id="loading-container">
                <div class="spinner"></div>
                <p>Creating Taxonomy...</p>
            </div>
        </div>
    </main>
</div>

<div id="info-panel">
    <p id="info-content"></p>
</div>


<script type="text/javascript">

    function folderSelector() {
        const folderInput = document.getElementById('folderInput');
        folderInput.click();

        folderInput.onchange = (event) => {
            const files = event.target.files;
            if (files.length > 0) {
                // Extract folder name from the first file path
                const fullPath = files[0].webkitRelativePath;
                const folderName = fullPath.split('/')[0];
                document.getElementById('path').value = folderName;
            }
        };
    }

    document.getElementById("enter").addEventListener("click", function() {
        const folder_path = document.getElementById("path").value;
        const supportValue = document.getElementById("support").value;
        const confidenceValue = document.getElementById("confidence").value;
        const phrase_length = document.getElementById("phrase_length").value;
        const text_mining = document.getElementById("text_mining").value;
        const chunkThr = document.getElementById("chunkThr").value;
        const topK = document.getElementById("topk").value

        physics_en = true;

        // Check if the values are valid
        if (!supportValue || !confidenceValue || !phrase_length || !text_mining) {
            alert("Please fill all fields.");
            return;
        }

        const data = {
            path: folder_path,
            support: supportValue,
            confidence: confidenceValue,
            phrase_length: phrase_length,
            granularity: text_mining.toUpperCase(),
            topK: topK
        };

        // Include optional threshold if chunk mode is chosen
        if (text_mining.toUpperCase() === "CHUNK") {
            data.chunkThr = chunkThr;
        }

        console.log("Submitting request:", data);

        // Show the loading animation
        const loadingContainer = document.getElementById("loading-container");
        // loadingContainer.style.display = "block"; // Changed to flex for better centering
        loadingContainer.style.display = "flex";


        let allNodes = [];
        let allEdges = [];

        // Fetch graph data from the API
        fetch("/api/submit-values", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(graphDt => {
                allNodes = Object.entries(graphDt.nodes).map(([id, data]) => ({
                    id: id,
                    label: `${data.label}\nPR: ${data.rank?.toFixed(3) ?? 0}`,
                    level: data.level
                }));


                function getColorByValue(value, min = 0, max = 1) {
                    const normalized = (value - min) / (max - min);

                    const r = Math.floor(255 * (1 - normalized));
                    const g = 0;
                    const b = Math.floor(255 * normalized);

                    return `rgb(${r},${g},${b})`;
                }

                allEdges = graphDt.edges.map(edge => ({
                    from: edge.from,
                    to: edge.to,
                    confidence: edge.confidence.toFixed(3),
                    support: edge.support.toFixed(3),
                    arrows: "to",
                    label: graphDt.edges.length <= 20 ? `C = ${edge.confidence.toFixed(3)}\nS = ${edge.support.toFixed(3)}` : "",
                    color: getColorByValue(edge.confidence)
                }));

                // Sort by PageRank (descending)
                const sorted = [...allNodes].sort((a, b) => b.rank - a.rank);
                const topNodes = sorted.slice(0, topK);
                const topIds = new Set(topNodes.map(n => n.id));

                console.log("SORTED",sorted,"TOP",topNodes,"IDs",topIds);

                // Only include edges between top nodes
                const filteredEdges = allEdges.filter(
                    e => topIds.has(e.from) && topIds.has(e.to)
                );

                //console.log("FILTER",filteredEdges);

                const nodes = new vis.DataSet(topNodes);
                const edges = new vis.DataSet(filteredEdges);

                //console.log("NODES",nodes,"EDGES",edges);

                const container = document.getElementById("network-container");
                container.innerHTML = ""; // This still works to remove the drop_zone

                const data = { nodes, edges };

                // new vis.Network(container, data); // This line is redundant

                const options = {
                    layout: {
                        hierarchical: {
                            enabled: true,
                            levelSeparation: 100,
                            nodeSpacing: 400,
                            treeSpacing: 200,
                            blockShifting: false,
                            edgeMinimization: true,
                            parentCentralization: true,
                            direction: 'DU',
                            sortMethod: 'directed'
                        }
                    },

                    interaction: {
                        tooltipDelay: 100
                    },

                    physics: {
                        maxVelocity: 300,
                        minVelocity: 1,
                        hierarchicalRepulsion: {
                            nodeDistance: 400
                        }
                    },

                    edges: {
                        smooth: {
                            type: 'curvedCW',
                            roundness: 0.5
                        },
                        arrows: {
                            to: { enabled: true, scaleFactor: 0.5 }
                        }
                    },


                    nodes: {
                        font: { size: 14 } // Default size, will be overwritten by slider
                    }
                };

                // Initialize the network
                const network = new vis.Network(container, data, options);
                const infoPanel = document.getElementById('info-panel');
                const infoContent = document.getElementById('info-content');

                network.on("click", function (params) {
                    if (params.nodes.length) {
                        const nodeId = params.nodes[0];
                        const nodeData = nodes.get(nodeId);
                        // Populate the panel with node information
                        infoContent.innerHTML = `
                            <strong>Node Info:</strong><br>
                            ID: ${nodeData.id}<br>
                            Level: ${nodeData.level}
                        `;
                        // Show the panel near the clicked position
                        showPanel(params.pointer.DOM);
                    } else if (params.edges.length) {
                        const edgeId = params.edges[0];
                        const edgeData = edges.get(edgeId);
                        // Populate the panel with edge information
                        infoContent.innerHTML = `
                            <strong>Edge Info:</strong><br>
                            From: ${edgeData.from}<br>
                            To: ${edgeData.to}<br>
                            Confidence: ${edgeData.confidence} <br>
                            Support:  ${edgeData.support}
                        `;
                        // Show the panel near the clicked position
                        showPanel(params.pointer.DOM);
                    } else {
                        // Hide the panel if no nodes or edges are clicked
                        hidePanel();
                    }
                });
                function showPanel(position) {
                    infoPanel.style.display = 'block';
                    infoPanel.style.left = position.x + 'px'; // Set panel's left position
                    infoPanel.style.top = position.y + 'px'; // Set panel's top position
                }

                // Function to hide the panel
                function hidePanel() {
                    infoPanel.style.display = 'none';
                }

                // Hide the panel when clicking outside the network
                // This listener was duplicated, I'm keeping the second one
                network.on("click", function (params) {
                    if (!params.nodes.length && !params.edges.length) {
                        hidePanel();
                    }
                });

                // Update font size based on slider input
                document.getElementById("slider").addEventListener("input", function() {
                    const fontSize = parseInt(this.value, 10);
                    nodes.update(nodes.get().map(node => ({ ...node, font: { size: fontSize } })));
                });

                document.getElementById("hide-edges-checkbox").addEventListener("change", function () {
                    const hideEdges = this.checked; // Check if the checkbox is toggled

                    if (hideEdges) {
                        // Temporarily hide all edges
                        network.setOptions({
                            edges: {
                                hidden: true
                            }
                        });
                    } else {
                        // Show all edges again
                        network.setOptions({
                            edges: {
                                hidden: false
                            }
                        });
                    }
                });

                // Hide the loading spinner
                loadingContainer.style.display = "none";
            })
            .catch(error => {
                console.error("Error fetching graph data:", error);
                alert("An error occurred while fetching the taxonomy.");
                loadingContainer.style.display = "none";  // Hide the loader if there was an error
            });
    });
</script>


<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {

        // Sidebar Toggle
        const toggleButton = document.getElementById("sidebar-toggle");
        const appContainer = document.querySelector(".app-container");

        toggleButton.addEventListener("click", function() {
            appContainer.classList.toggle("sidebar-collapsed");
        });

        // Dark Mode Toggle
        const darkModeToggle = document.getElementById("dark-mode-toggle");
        darkModeToggle.addEventListener("change", function() {
            if (this.checked) {
                document.body.classList.add("dark-mode");
            } else {
                document.body.classList.remove("dark-mode");
            }
        });

    });
</script>


</body>
</html>


